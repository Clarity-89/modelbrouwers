{% extends "albums/base.html" %}

{% block extrastyle %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/uploadify.css" />
<style type="text/css">
#new-album-upload{display:none;}
</style>
<!--[if IE]>
	<style type="text/css">
		th.label{width:25%;}
		td.field{width:auto;}
	</style>
<![endif]-->
<!--[if IE 7]>
	<style type="text/css">
		#id_album{border-width:2px;}
		/*td.field{width:auto;}*/
		#create_new_album button{padding:0;}
		a#start_upload{margin-left:3em;margin-bottom:1em;}
	</style>
<![endif]-->
{% endblock %}

{% block extrascript %}
<script type="text/javascript" src="{{ STATIC_URL }}scripts/jquery.uploadify-3.1.min.js"></script>
<script type="text/javascript">
var url_new = "{% url brouwers.albums.ajax_views.new_album_jquery_ui %}";
var success_icon = '&nbsp;<img src="{{ STATIC_URL }}admin/img/icon-yes.gif" width="10" height="10" alt="ok"></img>';

$(document).ready(function() {
    /* uploadify */
    var albumId;
    var button = '<button class="uploadify-button" style="height: 34px; line-height: 30px; width: 124px;">Extra info</button>';
    var button2 = '<button class="uploadify-button" style="height: 34px; line-height: 30px; width: 124px;">Voltooien</button>';
	var photo_ids = "";
    
    $('#uploadify_input').uploadify({
        'swf'       : '{{ STATIC_URL }}scripts/uploadify.swf',
        'uploader'  : '{% url brouwers.albums.ajax_views.uploadify %}',
        'auto'      : {% if album_preferences.auto_start_uploading %}true{% else %}false{% endif %},
        'buttonText': 'Selecteer foto\'s',
        'queueID'   : 'upload_queue',
        'preventCaching': true,
        'fileSizeLimit' : '18MB',
        'fileTypeDesc'  : 'Afbeeldingen',
        'fileTypeExts'  : '*.jpeg; *.jpg; *.png; *.PNG; *.JPG; *.JPEG',
        'formData'  : {'album': 'nope'},
        'method'    : 'post',
        'removeCompleted'   : false,
        'onUploadStart' : function(file) {
            albumId = $('#id_album').val();
            $("#uploadify_input").uploadify("settings", "formData", {'album': albumId, '{{ session_cookie_name }}': '{{ session_key }}'});
        },
        'onUploadSuccess': function(file, data, response) {
            photo_ids += data + "+";
        },
        'onUploadError' : function(file, errorCode, errorMsg, errorString) {
            alert(errorString);
        },
        'onQueueComplete' : function(queueData) {
            //remove the previous button
            var href = '/albums/upload/uploadify/complete/?album='+albumId+'&photo_ids='+photo_ids;
            $('a#next_step').html(button);
            $('a#next_step').attr("href", href);
            $('a#next_step').show();
            
            var href2 = '{% url brouwers.albums.views.browse_album "0" %}';
            href2 = href2.replace('0', albumId);
            $('a#end-upload').html(button2);
            $('a#end-upload').attr("href", href2);
            $('a#end-upload').show();
        },
        'onDialogOpen' : function() {
            $('#queue-title').show();
            $('a#next_step').hide();
        }
    });
    
    $('#new-album-upload').dialog({
	    autoOpen: false,
		height: 400,
		width: 800,
		modal: true,
		title: "Nieuw album",
		buttons: {
		    "Bewaren": function(){
		        data = $('#new-album').serializeArray();
		        $.post(
		            url_new,
		            data,
		            function (response){
		                var response = $(response);
		                option = response.find('option.new_album');
		                if (option.length > 0){ //success
		                    $('#id_album:selected').attr('selected', '');
		                    $('#id_album').append(option);
		                    $('#new-album-upload').dialog('close');
		                }
		                else{
		                    $("#new-album").html(response);
		                }
		            }
		        );
		    },
		    "Annuleren": function() {
		        $(this).dialog("close");
		    }
		}
	});
    
    $('a#create_new_album').click(function(e){
        e.preventDefault();
        $('#new-album-upload').dialog('open');
        return false;
    });
    
    $('#start_upload').click(function (){
        var form = $('form#special-form');
        albumId = $('#id_album').val();
        
        if ($('#id_url').val() != ''){
            $.post(
                '{% url brouwers.albums.ajax_views.upload_url %}',
                form.serialize(),
                function (response){
                    var intRegex = /^\d+$/;
                    if(intRegex.test(response)) { // integer? (photo id)
                        $('#url-errors').remove();
                        //$('#id_url').val('');
                        $('#id_url').after(success_icon);
                        var next = $('a#next_step');
                        
                        if (next.html() == ''){
                            next.html(button);
                            href = '{% url brouwers.albums.views.pre_extra_info_uploadify %}?album=';
                            href += albumId + '&photo_ids=' + response + '+';
                            next.attr("href", href);
                            next.show();
                        } else {
                            href = next.attr("href") + response + '+';
                            next.attr("href", href);
                        }
                    } else { // real response -> errors have occured
                        $('#url-row').replaceWith(response);
                        $('#url-row td.help_text div').hide();
                    }
                }
            );
        }
    });
});
function add_album(e){ // no longer used
    //POST data
    var title = $('#id_title').val();
    var desc = $('#id_description').val();
    var cat = $('#id_category').val();
    var pub = $('#id_public').val();
    var build_report = $('#id_build_report').val();
    var perm = $('#id_writable_to').val();
    // post the data
    $.post('{% url brouwers.albums.ajax_views.new_album %}', {
        title: title,
        description: desc,
        category: cat,
        public: pub,
        build_report: build_report,
        writable_to: perm
        },
        function(response){
            var status = $(response).find('#status').val();
            var id = status;
            var title = $(response).attr('title');
            if (status == 'invalid'){ //show form error(s)
                $('div#new_album').html(response);
            } else { // add option to select and remove selected option
                $('#id_album').append($("<option></option>").attr("value", id).text(title));
                $('#id_album').val(id);
                $('a#create_new_album').show();
                $(e).parent().parent().parent().parent().parent().remove();
            }
        }
    );
} 
</script>
{% endblock extrascript %}

{% block content %}
<div class="tab">Upload images</div>
<div class="no-javascript" class="margin">
    Je browser ondersteunt geen Javascript, wat vereist is voor deze uploader. Je kan de <a href="{% url brouwers.albums.views.upload %}">alternatieve uploader</a> gebruiken.
</div>

<div class="info margin">Op deze pagina kan je foto's uploaden. Kies het album waarnaar je wil uploaden en voeg de foto's toe. In een volgende stap kan je desgewenst een beschrijving invullen.</div>

<div id="forms" class="margin">
<form id="special-form">
    <table>
        <tr>
            <th class="label">Uploaden naar</th>
            {% spaceless %}
			<td class="field">{{ albumform.album }} 
                <a href="/albums/manage/#new" id="create_new_album" >
                    <button>Nieuw album</button>
                </a>
            </td>
			{% endspaceless %}
        </tr>
        {% include "albums/uploadify_url.html" %}
    </table>
</form>
</div>

<div id="new-album-upload">
    <form id="new-album">
        {% include "form_in_table_jquery-ui.html" %}
        <input type="hidden" name="from-page" value="upload" />
    </form>
</div>

{% spaceless %}
<div id="uploadify">
    <input type="file" name="file_upload" id="uploadify_input" />
    <a onclick="$('#uploadify_input').uploadify('upload', '*');" id="start_upload">
        <button class="uploadify-button" style="height: 34px; line-height: 30px; width: 124px;">Begin upload</button></a>
    <a id="end-upload" href="" style="display:none;"></a>
    <a id="next_step" href="" style="display:none;"></a>
    <div class="subtitle tab" style="display: none;" id="queue-title">Upload queue</div>
    <div id="upload_queue"></div>
</div>
{% endspaceless %}
<div class="clear"></div>
{% endblock content %}
